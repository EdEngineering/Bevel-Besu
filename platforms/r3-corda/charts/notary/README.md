[//]: # (##############################################################################################)
[//]: # (Copyright Accenture. All Rights Reserved.)
[//]: # (SPDX-License-Identifier: Apache-2.0)
[//]: # (##############################################################################################)

# NOTARY

Following chart contains Kubernetes deployment, service, pvc ,configmap for deploying corda node. 
A node is JVM run-time with a unique network identity running the Corda software.

For more information read [corda notary](https://docs.corda.net/releases/release-V3.3/key-concepts-notaries.html)

This chart has following structure:
```
  .
  ├── notary
  │   ├── Chart.yaml
  │   ├── templates
  │   │   ├── deployment.yaml
  │   │   ├── _helpers.tpl
  │   │   ├── pvc.yaml
  │   │   └── service.yaml
  │   └── values.yaml
```

Type of files used:

```
charts.yaml       : A YAML file containing information about the chart
deployment.yaml   : A Deployment controller provides declarative updates for Pods and ReplicaSets.
_helpers.tpl      : A place to put template helpers that you can re-use throughout the chart
pvc.yaml          : A PersistentVolumeClaim (PVC) is a request for storage by a user.
service.yaml      : An abstract way to expose an application running on a set of Pods as a network service.
values.yaml       : This file contains the default values for a chart
```


## Running the chart

Pre-Requisite: Before deploying the chart please ensure you have Networkmap and Node's database up and running. 

- Deploy Networkmap & Node's Database by following steps from documentation 
- Create secrets for the node by following steps from documentation 
- Create a values-node.yaml for the chart with a minimum set of keys, for template references use values.yaml present in the respective chart
- Create aws cli script to transfer artmis folder (which gets created by corda node) to and from AWS s3  

Install the chart with:

```
helm install --set-file "awscliscript=<aws-cli script name>" -f ${PATH_TO_VALUES}/<node name>/values-node.yaml --set metadata.namespace=<node namespace> ${PATH_TO_HELMCHARTS}/notary --name <helm name> --kube-context=<kube context> --namespace=<node namespace>

```

If you need to delete the chart use:

```
helm uninstall <helm name> -n <namespace> --kube-context=<kube context>
```

# Chart Functionalities

## deployment.yaml 

Contains following containers:

### Main Containers: 

1. notary: 	 Tasks performed in this container

- Setting up enviroment variables required for corda jar
- import self signed tls certificate of doorman and networkmap, since java only trusts certificate signed by well known CA  
- to clean network-parameters on every restart 
- command to run corda jar, we are setting javax.net.ssl.keyStore as ${BASE_DIR}/certificates/sslkeystore.jks since keystore gets reset when using h2 ssl 

2. corda-logs:  Tasks performed in this container   
 
- Loop to check if log file is generated by corda and keep on printing log file if it is generated by corda 
- setting up env to get secrets from vault
- save networkmap password from vault for authentication of networkmap
- get node-info file name and get url for registration from values,check if notary type is validating or non validating from values.yaml, and form url accordingly.
- get one time login token from networkmap.
- curl command to register notary, if response is okay then registration is successful.

### Init-containers:

1. init-checkregistration: This container is used for init-checkregistration  
   Tasks performed in this container
- set env to get secrets from vault
- get truststore from vault to see if registration is done or not
- printing number of trial done before giving up

2. init-nodeconf: This container is used for creating node.conf which is used by corda node.  
   For more details on how to make node.conf read [node configuration](https://docs.corda.net/releases/release-V3.3/corda-configuration-file.html)
   Tasks performed in this container

- Delete previously created node.conf, and create a new node.conf
- Set env to get secrets from vault
- Save keyStorePassword & trustStorePassword from vault
- Save dataSourceUserPassword from vault
- Create node.conf according to values specifi

3. init-certificates:  This container is used for downloading certficate from vault  
   For more details on read [Network permissioning](https://docs.corda.net/releases/release-V3.3/permissioning.html)  
   Tasks performed in this container
- setting up env to get secrets from vault
- get nodekeystore.jks from vault
- get sslkeystore.jks from vault
- get truststore.jks from vault
- get network-map-truststore.jks from vault
- when using h2-ssl with private certificate, download the certificate  (To import in ca cert in main corda container)
- when using doorman and networkmap in TLS: true, and using private certificate then download certificate(To import in ca cert in main corda container)
- when using custom sslKeystore while setting in node.conf
- To download jars from git repo, download private key (corresponding public key to be added in git repo)
- get aws access key id and secret access key, it is used for accessing AWS s3 for artmis folder 

4. db-healthcheck: This container is used for performing health check  
  Tasks performed in this container
- perform health check if db is up and running before starting corda node

5. init-cordapps:  This container is used for creating cordapps dir in volume to keep jars
Tasks performed in this container
-  creating cordapps dir in volume to keep jars
- save cordapps repository login password from vault
- Downloading official corda provided jars using curl

## service.yaml 

Contains port specifications for: 

1. p2p communication among corda node 
2. rpc communication between corda node and webserver
3. rpc admin communication 
4. communication with springboot web  (added only if webserver is enabled and number is based on values specified by user in values.yaml)

## pvc.yaml 

Contains specifications for: 

1. To create pvc used by node
2. To create pvc used for each webserver deployed (added only if webserver is enabled and number is based on values specified by user in values.yaml)


## Updating configuration

Updates to configuration are handled dynamically by the service

 Modify the values.yaml you're using and simply run: 

```
helm upgrade --install --set-file "awscliscript=<aws-cli script name>" -f ${PATH_TO_VALUES}/<node name>/values-node.yaml --set metadata.namespace=<node namespace> ${PATH_TO_HELMCHARTS}/notary --name <helm name> --kube-context=<kube context> --namespace=<node namespace> --recreate-pods
```

Using the '--recreate-pods' is not required to get updates of config to the running controller.
